<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dino Evolution - Population wird berechnet...</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a3a1a, #2d5a2d);
            color: #e8d5c4;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #32cd32;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .subtitle {
            color: #cd853f;
            font-size: 1.2em;
        }

        .session-info {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .population-display {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #32cd32;
            border-radius: 15px;
            padding: 30px;
            min-width: 600px;
            max-width: 800px;
            text-align: center;
            max-height: 70vh;
            overflow-y: auto;
        }

        .species-section {
            margin-bottom: 30px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .species-section.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .species-title {
            color: #ff6b35;
            font-size: 1.5em;
            margin-bottom: 15px;
            border-bottom: 2px solid #8b4513;
            padding-bottom: 10px;
        }

        .species-title.enemy {
            color: #ff4444;
            border-bottom-color: #ff4444;
        }

        .dino-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .dino-counter {
            background: rgba(50, 205, 50, 0.2);
            border: 1px solid #32cd32;
            border-radius: 8px;
            padding: 15px;
            min-width: 120px;
            text-align: center;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
        }

        .dino-counter.visible {
            opacity: 1;
            transform: scale(1);
        }

        .dino-counter.adult {
            border-color: #ffa500;
            background: rgba(255, 165, 0, 0.2);
        }

        .dino-counter.juvenile {
            border-color: #87ceeb;
            background: rgba(135, 206, 235, 0.2);
        }

        .dino-counter.enemy {
            border-color: #ff4444;
            background: rgba(255, 68, 68, 0.2);
        }

        .dino-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .dino-label {
            font-size: 0.9em;
            color: #cd853f;
            margin-bottom: 5px;
        }

        .dino-count {
            font-size: 1.3em;
            font-weight: bold;
            color: #32cd32;
        }

        .enemy-section {
            margin-top: 40px;
            border-top: 2px solid #8b4513;
            padding-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #32cd32, #228b22);
            width: 0%;
            transition: width 0.3s ease;
        }

        .skip-button {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(255, 107, 53, 0.8);
            border: 2px solid #ff6b35;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .skip-button:hover {
            background: rgba(255, 107, 53, 1);
            transform: scale(1.05);
        }

        .final-message {
            margin-top: 30px;
            padding: 20px;
            background: rgba(50, 205, 50, 0.2);
            border: 2px solid #32cd32;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .final-message.visible {
            opacity: 1;
        }

        .loading-text {
            color: #32cd32;
            font-size: 1.1em;
            margin: 20px 0;
        }

        .error-message {
            background: rgba(255, 68, 68, 0.2);
            border: 2px solid #ff4444;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            color: #ff4444;
        }

        .error-message h3 {
            margin-bottom: 10px;
        }

        .retry-button {
            background: #ff6b35;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            margin-top: 15px;
        }

        .retry-button:hover {
            background: #ff8c42;
        }

        /* Scrollbar f√ºr population-display */
        .population-display::-webkit-scrollbar {
            width: 8px;
        }

        .population-display::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .population-display::-webkit-scrollbar-thumb {
            background: #32cd32;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß¨ EVOLUTION IN PROGRESS üß¨</h1>
            <div class="subtitle">Ihre Dinosaurier-Population wird berechnet...</div>
            <div class="session-info" id="sessionInfo"></div>
        </div>

        <div class="population-display">
            <div class="loading-text" id="loadingText">Verbinde mit Server...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div id="populationContainer"></div>
            <div id="errorContainer"></div>
            
            <div class="final-message" id="finalMessage">
                <h3>ü¶ï Population berechnet! ü¶ñ</h3>
                <p>Das √úberleben beginnt jetzt...</p>
            </div>
        </div>

        <button class="skip-button" onclick="skipAnimation()">‚è© √úberspringen</button>
    </div>

    <script src="dino-renderer.js"></script>
    <script src="dino-abilities.js"></script>

    <script>
        // ===================================
        // GLOBALE VARIABLEN
        // ===================================
        
        let sessionId = null;
        let selectedSlots = [];
        let enemySlots = [];
        let currentLevel = 1;
        let animationSkipped = false;
        let isLoading = false;
        
        // API Base URL
        const API_BASE = 'http://localhost:3001/api/game';
        
        // ===================================
        // GEGNER-SLOTS DEFINITION
        // ===================================


        // Ur-Gegner Basis (√§hnlich wie Spieler Ur-Dinos)
        const urEnemyBase = {
            gepanzert: 10, stachelig: 8, farbig: 20, tarnung: 30,
            kopf_beisskraft: 35, kopf_gr√∂√üe: 45, kopf_h√∂rner_anzahl: 0,
            kopf_h√∂rner_gr√∂√üe: 0, kragen_gr√∂√üe: 0, maul_zahntyp: 40,
            hals_l√§nge: 30, hals_breite: 40, k√∂rper_l√§nge: 80, k√∂rper_h√∂he: 38,
            vorderbeine_l√§nge: 60, vorderbeine_st√§rke: 45, vorderklauen_l√§nge: 20,
            hinterbeine_l√§nge: 65, hinterbeine_st√§rke: 50, hinterklauen_l√§nge: 20,
            schwanz_l√§nge: 70, schwanz_breite: 30, schwanz_keule: 0, schwanz_stacheln: 0,
            fl√ºgel: 0, flossen: 0, fleisch: 35, pflanzen: 35, aas: 35
        };

        // Funktion f√ºr evolution√§re Anpassung
        function evolveEnemy(baseProps, evolutionStage, specialization) {
            const props = { ...baseProps };
            
            // Basis-Evolution pro Stufe
            const evolutionBoost = 1 + (evolutionStage * 0.15);
            
            // Allgemeine Verbesserungen
            const generalStats = ['kopf_gr√∂√üe', 'k√∂rper_l√§nge', 'k√∂rper_h√∂he', 
                                'vorderbeine_st√§rke', 'hinterbeine_st√§rke'];
            generalStats.forEach(stat => {
                props[stat] = Math.min(100, Math.round(props[stat] * evolutionBoost));
            });
            
            // Spezialisierung anwenden
            switch(specialization) {
                case 'predator':
                    // Raubtier-Evolution
                    props.kopf_beisskraft = Math.min(100, props.kopf_beisskraft + evolutionStage * 15);
                    props.maul_zahntyp = Math.min(100, props.maul_zahntyp + evolutionStage * 12);
                    props.vorderklauen_l√§nge = Math.min(100, props.vorderklauen_l√§nge + evolutionStage * 10);
                    props.hinterklauen_l√§nge = Math.min(100, props.hinterklauen_l√§nge + evolutionStage * 10);
                    props.fleisch = Math.min(95, props.fleisch + evolutionStage * 15);
                    props.pflanzen = Math.max(5, props.pflanzen - evolutionStage * 10);
                    props.hinterbeine_l√§nge = Math.min(100, props.hinterbeine_l√§nge + evolutionStage * 8);
                    props.tarnung = Math.min(100, props.tarnung + evolutionStage * 5);
                    break;
                    
                case 'herbivore':
                    // Pflanzenfresser-Evolution
                    props.gepanzert = Math.min(100, props.gepanzert + evolutionStage * 12);
                    props.kopf_h√∂rner_anzahl = Math.min(3, Math.floor(evolutionStage / 2));
                    props.kopf_h√∂rner_gr√∂√üe = Math.min(100, evolutionStage * 15);
                    props.kragen_gr√∂√üe = Math.min(100, evolutionStage * 18);
                    props.schwanz_keule = Math.min(100, evolutionStage * 15);
                    props.pflanzen = Math.min(95, props.pflanzen + evolutionStage * 15);
                    props.fleisch = Math.max(5, props.fleisch - evolutionStage * 10);
                    props.k√∂rper_h√∂he = Math.min(100, props.k√∂rper_h√∂he + evolutionStage * 10);
                    break;
                    
                case 'defender':
                    // Verteidiger-Evolution
                    props.gepanzert = Math.min(100, props.gepanzert + evolutionStage * 18);
                    props.stachelig = Math.min(100, props.stachelig + evolutionStage * 15);
                    props.schwanz_stacheln = Math.min(100, evolutionStage * 20);
                    props.kragen_gr√∂√üe = Math.min(100, evolutionStage * 12);
                    props.k√∂rper_breite = Math.min(100, props.k√∂rper_breite + evolutionStage * 8);
                    break;
                    
                case 'aerial':
                    // Flug-Evolution (ab Level 4)
                    if (evolutionStage >= 3) {
                        props.fl√ºgel = Math.min(100, (evolutionStage - 2) * 30);
                        props.k√∂rper_h√∂he = Math.max(30, props.k√∂rper_h√∂he - 10);
                        props.vorderbeine_l√§nge = Math.min(100, props.vorderbeine_l√§nge + 15);
                    }
                    break;
                    
                case 'aquatic':
                    // Wasser-Evolution (ab Level 4)
                    if (evolutionStage >= 3) {
                        props.flossen = Math.min(100, (evolutionStage - 2) * 30);
                        props.k√∂rper_l√§nge = Math.min(100, props.k√∂rper_l√§nge + 15);
                        props.schwanz_l√§nge = Math.min(100, props.schwanz_l√§nge + 10);
                    }
                    break;
                    
                case 'apex':
                    // Apex-Predator (ab Level 5)
                    if (evolutionStage >= 4) {
                        // T-Rex √§hnliche Evolution
                        props.kopf_beisskraft = Math.min(100, 70 + evolutionStage * 6);
                        props.kopf_gr√∂√üe = Math.min(100, 60 + evolutionStage * 8);
                        props.maul_zahntyp = Math.min(100, 70 + evolutionStage * 6);
                        props.hinterbeine_st√§rke = Math.min(100, 70 + evolutionStage * 5);
                        props.vorderbeine_l√§nge = Math.max(20, 50 - evolutionStage * 6); // Kleine Arme
                    }
                    break;
            }
            
            return props;
        }

        const ENEMY_SLOTS = [
            // Level 1 - Ur-Dinos mit leichter Varianz
            {
                name: "Ur-J√§ger", 
                level: 1,
                properties: evolveEnemy(urEnemyBase, 0, 'predator')
            },
            {
                name: "Ur-Sammler", 
                level: 1,
                properties: evolveEnemy(urEnemyBase, 0, 'herbivore')
            },
            
            // Level 2 - Erste Evolution
            {
                name: "Proto-R√§uber", 
                level: 2,
                properties: evolveEnemy(urEnemyBase, 1, 'predator')
            },
            {
                name: "Fr√ºh-Verteidiger", 
                level: 2,
                properties: evolveEnemy(urEnemyBase, 1, 'defender')
            },
            
            // Level 3 - Mittlere Evolution
            {
                name: "Sichelklauen-J√§ger", 
                level: 3,
                properties: evolveEnemy(urEnemyBase, 2, 'predator')
            },
            {
                name: "Panzer-Pflanzenfresser", 
                level: 3,
                properties: evolveEnemy(urEnemyBase, 2, 'herbivore')
            },
            {
                name: "Stachel-Verteidiger", 
                level: 3,
                properties: evolveEnemy(urEnemyBase, 2, 'defender')
            },
            
            // Level 4 - Fortgeschrittene Evolution
            {
                name: "Flug-J√§ger", 
                level: 4,
                properties: evolveEnemy(urEnemyBase, 3, 'aerial')
            },
            {
                name: "Wasser-R√§uber", 
                level: 4,
                properties: evolveEnemy(urEnemyBase, 3, 'aquatic')
            },
            {
                name: "Geh√∂rnter Titan", 
                level: 4,
                properties: evolveEnemy(urEnemyBase, 3, 'herbivore')
            },
            
            // Level 5 - Fast vollst√§ndige Evolution
            {
                name: "Proto-Rex", 
                level: 5,
                properties: evolveEnemy(urEnemyBase, 4, 'apex')
            },
            {
                name: "Langhals-Riese", 
                level: 5,
                properties: (() => {
                    const props = evolveEnemy(urEnemyBase, 4, 'herbivore');
                    props.hals_l√§nge = 85;
                    props.k√∂rper_h√∂he = 90;
                    props.k√∂rper_l√§nge = 95;
                    return props;
                })()
            },
            
            // Level 6+ - Voll entwickelte Apex-Predatoren
            {
                name: "Tyranno-Rex", 
                level: 6,
                properties: evolveEnemy(urEnemyBase, 5, 'apex')
            },
            {
                name: "Mega-Brachiosaurus", 
                level: 6,
                properties: (() => {
                    const props = evolveEnemy(urEnemyBase, 5, 'herbivore');
                    props.hals_l√§nge = 95;
                    props.k√∂rper_h√∂he = 95;
                    props.k√∂rper_l√§nge = 100;
                    props.vorderbeine_l√§nge = 85;
                    return props;
                })()
            },
            {
                name: "Ultimate Predator", 
                level: 7,
                properties: evolveEnemy(urEnemyBase, 6, 'apex')
            }
        ];

        // Optional: Zuf√§llige Varianz f√ºr mehr Abwechslung
        ENEMY_SLOTS.forEach(enemy => {
            // Kleine zuf√§llige Varianz (¬±5) f√ºr einige Eigenschaften
            const varyProps = ['gepanzert', 'farbig', 'tarnung', 'kopf_gr√∂√üe'];
            varyProps.forEach(prop => {
                const variance = Math.floor(Math.random() * 11) - 5; // -5 bis +5
                enemy.properties[prop] = Math.max(0, Math.min(100, enemy.properties[prop] + variance));
            });
        });


        // ===================================
        // DATEN LADEN
        // ===================================

        async function loadGameData() {
            try {
                setLoadingText('Pr√ºfe Session...');
                
                // ROBUSTES URL-PARSING
                console.log('üîç URL:', window.location.href);
                
                sessionId = null;
                
                // METHODE 1: RegEx (am zuverl√§ssigsten)
                const sessionMatch = window.location.href.match(/session=([a-f0-9-]+)/i);
                if (sessionMatch && sessionMatch[1]) {
                    sessionId = sessionMatch[1];
                    console.log('‚úÖ Session-ID gefunden:', sessionId);
                }
                
                if (!sessionId) {
                    throw new Error('Keine Session-ID in URL gefunden');
                }
                
                // Session-ID global setzen
                window.sessionId = sessionId;
                // Wichtig: Setze auch die globale Variable f√ºr savePopulationToServer
                if (typeof window !== 'undefined') {
                    window.sessionId = sessionId;
                }
                // Globale Variable setzen
                sessionId = sessionMatch[1];
                
                updateSessionInfo();
                setLoadingText('Lade Evolutionsdaten...');
                
                console.log(`üìÇ Lade Daten f√ºr Session: ${sessionId}`);
                
                const response = await fetch(`${API_BASE}/load-evolution/${sessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    selectedSlots = data.gameData.selectedSlots || [];
                    currentLevel = data.gameData.currentLevel || 1;
                    
                    console.log('‚úÖ Evolution-Daten geladen:', data.gameData);
                    
                    if (selectedSlots.length === 0) {
                        throw new Error('Keine Dinosaurier-Arten ausgew√§hlt');
                    }
                    
                    return true;
                } else {
                    throw new Error(data.error || 'Fehler beim Laden der Daten');
                }
                
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Spieldaten:', error);
                showError('Fehler beim Laden', error.message);
                return false;
            }
        }

        // ===================================
        // POPULATION BERECHNUNG
        // ===================================

        function calculatePopulation(species) {
            const props = species.properties;
            
            const baseAdults = 2 + Math.floor(Math.random() * 3);
            const reproductionFactor = (props.fortpflanzungsgeschwindigkeit || 50) / 100;
            const childrenMultiplier = 0.5 + reproductionFactor * 1.5;
            const maturationTime = (props.zeit_zur_erwachsenwerdung || 50) / 100;
            const maturationFactor = 0.8 + maturationTime * 0.4;
            
            let adults = Math.max(2, Math.min(20, Math.round(baseAdults * maturationFactor)));
            let juveniles = Math.max(1, Math.min(15, Math.round(adults * childrenMultiplier)));
            
            // NEU: Level-basierte Anpassung f√ºr Gegner
            if (species.level && currentLevel > 1) {
                const levelMultiplier = 1 + (currentLevel - 1) * 0.3;
                adults = Math.round(adults * levelMultiplier);
                juveniles = Math.round(juveniles * levelMultiplier);
                
                adults = Math.min(25, adults);
                juveniles = Math.min(20, juveniles);
                
                console.log(`üìà Level ${currentLevel} Boost f√ºr ${species.name}: ${adults} Erwachsene, ${juveniles} Jungtiere`);
            }
            
            return {
                adults: adults,
                juveniles: juveniles,
                total: adults + juveniles
            };
        }

        function selectEnemiesForLevel(level) {
            console.log(`üéØ W√§hle Gegner f√ºr Level ${level} (exponentielles System)`);
            
            enemySlots = [];
            
            const maxEnemyLevel = Math.min(level + 1, 6);
            let enemyCount, levelMultiplier;
            
            if (level === 1) {
                enemyCount = 2;
                levelMultiplier = 1;
            } else if (level === 2) {
                enemyCount = 3;
                levelMultiplier = 1.2;
            } else if (level === 3) {
                enemyCount = 4;
                levelMultiplier = 1.5;
            } else if (level === 4) {
                enemyCount = 5;
                levelMultiplier = 1.8;
            } else if (level >= 5) {
                enemyCount = 6;
                levelMultiplier = 2.0;
            }
            
            const availableEnemies = ENEMY_SLOTS.filter(enemy => enemy.level <= maxEnemyLevel);
            const selectedEnemies = [];
            
            const highLevelEnemies = availableEnemies.filter(enemy => enemy.level >= Math.max(1, level - 1));
            const lowLevelEnemies = availableEnemies.filter(enemy => enemy.level < Math.max(1, level - 1));
            
            const highLevelSlots = Math.ceil(enemyCount * 0.7);
            const lowLevelSlots = enemyCount - highLevelSlots;
            
            for (let i = 0; i < highLevelSlots && i < highLevelEnemies.length; i++) {
                const enemy = { ...highLevelEnemies[i % highLevelEnemies.length] };
                
                if (level > enemy.level) {
                    const boost = Math.pow(1.15, level - enemy.level);
                    boostEnemyStats(enemy, boost, level);
                }
                
                selectedEnemies.push(enemy);
            }
            
            for (let i = 0; i < lowLevelSlots && i < lowLevelEnemies.length; i++) {
                const enemy = { ...lowLevelEnemies[i % lowLevelEnemies.length] };
                selectedEnemies.push(enemy);
            }
            
            enemySlots = selectedEnemies;
            
            console.log(`üìä Level ${level}: ${enemySlots.length} Gegnerarten, Max-Enemy-Level: ${maxEnemyLevel}`);
            enemySlots.forEach(enemy => {
                console.log(`  - ${enemy.name} (Level ${enemy.level})`);
            });
        }

        function boostEnemyStats(enemy, multiplier, currentLevel) {
            console.log(`‚ö° Boost ${enemy.name}: ${multiplier.toFixed(2)}x f√ºr Level ${currentLevel}`);
            
            const combatStats = [
                'kopf_beisskraft', 'kopf_gr√∂√üe', 'kopf_h√∂rner_anzahl', 'kopf_h√∂rner_gr√∂√üe',
                'maul_zahntyp', 'k√∂rper_l√§nge', 'k√∂rper_h√∂he', 'gepanzert', 'stachelig',
                'vorderbeine_st√§rke', 'vorderklauen_l√§nge', 'hinterbeine_st√§rke', 'hinterklauen_l√§nge',
                'schwanz_keule', 'schwanz_stacheln', 'fleisch', 'tarnung'
            ];
            
            combatStats.forEach(stat => {
                if (enemy.properties[stat] > 0) {
                    enemy.properties[stat] = Math.min(100, Math.round(enemy.properties[stat] * multiplier));
                }
            });
            
            enemy.name = `${enemy.name} (L${currentLevel})`;
        }

        // ===================================
        // POPULATION-ANIMATION
        // ===================================

        async function startPopulationAnimation() {
            if (selectedSlots.length === 0) {
                showError('Keine Daten', 'Keine Dinosaurier-Arten gefunden');
                return;
            }
            
            setLoadingText('Berechne Populationen...');
            
            // Gegner f√ºr Level ausw√§hlen
            selectEnemiesForLevel(currentLevel);
            console.log('üéØ Selected enemies:', enemySlots)
            
            // Populationen berechnen
            const populationData = [];
            selectedSlots.forEach(slot => {
                const population = calculatePopulation(slot);
                populationData.push({
                    species: slot,
                    population: population
                });
            });
            
            // Gegner-Populationen berechnen
            const enemyPopulationData = [];
            enemySlots.forEach(slot => {
                const population = calculatePopulation(slot);
                enemyPopulationData.push({
                    species: slot,
                    population: population
                });
            });
            
            console.log('ü¶ï Population Data:', populationData);
            console.log('‚öîÔ∏è Enemy Population Data:', enemyPopulationData);
            
            // Level-Daten f√ºr Server formatieren
            const levelData = {
                populationData: populationData.map(data => ({
                    name: data.species.name,
                    slotIndex: selectedSlots.indexOf(data.species),
                    type: getDinoType(data.species.properties),
                    properties: data.species.properties,
                    population: {
                        total: data.population.total,
                        adults: data.population.adults,
                        juveniles: data.population.juveniles,
                        isExtinct: false
                    }
                })),
                enemyData: enemyPopulationData.map(data => ({
                    name: data.species.name,
                    type: getDinoType(data.species.properties),
                    properties: data.species.properties,
                    population: {
                        total: data.population.total,
                        adults: data.population.adults,
                        juveniles: data.population.juveniles,
                        isExtinct: false
                    }
                })),
                currentLevel: currentLevel
            };
            
            // Population-Daten an Server senden
            console.log('üöÄ DEBUG: Rufe savePopulationToServer auf...');
            await savePopulationToServer(levelData);
            console.log('‚úÖ DEBUG: savePopulationToServer beendet');
            
            // Animation starten
            animatePopulation(populationData, enemyPopulationData);
        }

        async function savePopulationToServer(levelData) {
            console.log('üì§ DEBUG: Sende levelData an Server:', levelData);
            
            if (sessionId && !sessionId.startsWith('offline')) {
                try {
                    setLoadingText('Speichere Population...');
                    
                    const requestData = {
                        sessionId: sessionId,
                        populationData: levelData.populationData,
                        enemyData: levelData.enemyData,
                        currentLevel: levelData.currentLevel // WICHTIG: Level mitgeben
                    };
                    
                    console.log('üì§ DEBUG: Request Data:', requestData);
                    
                    const response = await fetch(`${API_BASE}/save-population`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    const data = await response.json();
                    console.log('üì• DEBUG: Server Response:', data);
                    
                    if (data.success) {
                        console.log('üíæ Population gespeichert:', data);
                    } else {
                        console.warn('‚ö†Ô∏è Speichern fehlgeschlagen:', data.error);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Fehler beim Speichern der Population:', error);
                }
            } else {
                console.log('üîí DEBUG: Offline-Modus oder keine Session-ID');
            }
        }

        function animatePopulation(populationData, enemyPopulationData) {
            const container = document.getElementById('populationContainer');
            const progressFill = document.getElementById('progressFill');
            
            let totalSteps = 0;
            populationData.forEach(data => {
                totalSteps += data.population.adults + data.population.juveniles;
            });
            enemyPopulationData.forEach(data => {
                totalSteps += data.population.adults + data.population.juveniles;
            });
            
            let currentStep = 0;
            let html = '';
            
            function updateProgress() {
                const progress = (currentStep / totalSteps) * 100;
                progressFill.style.width = `${progress}%`;
            }
            
            function nextStep() {
                if (animationSkipped) {
                    finishAnimation();
                    return;
                }
                
                currentStep++;
                updateProgress();
                
                if (currentStep >= totalSteps) {
                    setTimeout(finishAnimation, 1000);
                } else {
                    setTimeout(nextStep, 200);
                }
            }
            
            // Eigene Arten anzeigen
            setLoadingText('Ihre Dinosaurier erwachen...');
            
            populationData.forEach((data, index) => {
                setTimeout(() => {
                    if (animationSkipped) return;
                    
                    html += `
                        <div class="species-section visible">
                            <div class="species-title">ü¶ï ${data.species.name}</div>
                            <div class="dino-grid">
                                <div class="dino-counter adult visible">
                                    <div class="dino-icon">ü¶ñ</div>
                                    <div class="dino-label">Erwachsene</div>
                                    <div class="dino-count">${data.population.adults}</div>
                                </div>
                                <div class="dino-counter juvenile visible">
                                    <div class="dino-icon">ü•ö</div>
                                    <div class="dino-label">Jungtiere</div>
                                    <div class="dino-count">${data.population.juveniles}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML = html;
                }, index * 1000);
            });
            
            // Gegner anzeigen
            setTimeout(() => {
                if (animationSkipped) return;
                
                setLoadingText('Feindliche Kreaturen erscheinen...');
                
                html += '<div class="enemy-section">';
                enemyPopulationData.forEach((data, index) => {
                    html += `
                        <div class="species-section visible">
                            <div class="species-title enemy">‚öîÔ∏è ${data.species.name}</div>
                            <div class="dino-grid">
                                <div class="dino-counter enemy visible">
                                    <div class="dino-icon">üíÄ</div>
                                    <div class="dino-label">Erwachsene</div>
                                    <div class="dino-count">${data.population.adults}</div>
                                </div>
                                <div class="dino-counter enemy visible">
                                    <div class="dino-icon">‚ò†Ô∏è</div>
                                    <div class="dino-label">Jungtiere</div>
                                    <div class="dino-count">${data.population.juveniles}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
                
                setTimeout(nextStep, 500);
                
            }, populationData.length * 1000 + 1000);
        }

        function finishAnimation() {
            const finalMessage = document.getElementById('finalMessage');
            finalMessage.classList.add('visible');
            
            setLoadingText('Bereite Level vor...'); 
            setTimeout(() => {
                // SESSION-ID NOCHMALS AUS URL EXTRAHIEREN (sicherer)
                let currentSessionId = sessionId;
                
                // Fallback: Aus aktueller URL extrahieren
                if (!currentSessionId) {
                    const currentUrl = new URL(window.location.href);
                    currentSessionId = currentUrl.searchParams.get('session');
                }
                
                console.log('üîç Redirect sessionId:', currentSessionId); // DEBUG
                
                if (currentSessionId) {
                    const urlParams = new URLSearchParams();
                    urlParams.set('session', currentSessionId);
                    window.location.href = `level.html?${urlParams.toString()}`;
                } else {
                    console.error('‚ùå Keine Session-ID f√ºr Redirect verf√ºgbar!');
                    // Fallback: Zur√ºck zum Generator
                    window.location.href = 'index.html';
                }
            }, 2000);
        }
        // ===================================
        // UI-HILFSFUNKTIONEN
        // ===================================

        function setLoadingText(text) {
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = text;
        }

        function updateSessionInfo() {
            const sessionInfo = document.getElementById('sessionInfo');
            if (sessionId) {
                if (sessionId.startsWith('offline')) {
                    sessionInfo.textContent = 'üîí Offline-Modus';
                } else {
                    sessionInfo.textContent = `üîó Session: ${sessionId.substring(0, 8)}...`;
                }
            }
        }

        function showError(title, message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `
                <div class="error-message">
                    <h3>‚ùå ${title}</h3>
                    <p>${message}</p>
                    <button class="retry-button" onclick="retryLoad()">üîÑ Erneut versuchen</button>
                    <button class="retry-button" onclick="goBackToIndex()" style="margin-left: 10px;">‚Üê Zur√ºck zum Generator</button>
                </div>
            `;
        }

        function skipAnimation() {
            animationSkipped = true;
            finishAnimation();
        }

        function retryLoad() {
            window.location.reload();
        }

        function goBackToIndex() {
            window.location.href = 'index.html';
        }

        function getDinoType(properties) {
            const ratio = properties.vorderbeine_l√§nge / properties.hinterbeine_l√§nge;
            if (ratio < 0.4) return 'zweif√º√üig';
            if (ratio < 0.8) return 'semi-zweif√º√üig';
            return 'vierf√º√üig';
        }

        // ===================================
        // INITIALISIERUNG
        // ===================================

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üß¨ Population Generator gestartet');
            
            const loadSuccess = await loadGameData();
            
            if (loadSuccess) {
                setTimeout(startPopulationAnimation, 1000);
            }
        });
    </script>
</body>
</html>